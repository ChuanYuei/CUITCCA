<!DOCTYPE html>
<html>
<head>
    <title>Index Management</title>
    <meta charset="UTF-8">
    <style>
        .index-item {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h1>Index Management</h1>

<div style="display: inline-block;">
    <h2>Create Index</h2>
    <input type="text" id="index-name" placeholder="Enter index name">
    <button onclick="createIndex()">Create</button>
    <p id="create-status"></p>
</div>
<div style="display: inline-block;">
    <button onclick="saveIndex()">Save</button>
</div>

<div style="display: inline-block;">
    <h2>Index List</h2>
    <div id="index-list"></div>
</div>

<button onclick="deleteIndex()">Delete Index</button>

<div id="summary" style="display: inline-block;"></div>

<button onclick="editSummary()">Edit Summary</button>

<div id="index-details">
    <h2>Index Details</h2>
    <div style="display: inline-block;">
        <h3 id="index-name-display"></h3>
    </div>
    <div style="display: inline-block;">
        <h2>Create Node</h2>
        <input type="text" id="node-text" placeholder="Enter node text">
        <input type="text" id="doc-id" placeholder="Enter doc_id">
        <button onclick="createNode()">Create</button>
    </div>
</div>

<h3>Nodes</h3>
<div id="node-list"></div>

<script>
    // API base URL
    const baseURL = 'http://127.0.0.1:8000/index';

    // Function to display index list
    async function displayIndexList() {
        const response = await fetch(`${baseURL}/list`);
        const data = await response.json();
        const indexList = data.indexes;

        const indexListDiv = document.getElementById('index-list');
        indexListDiv.innerHTML = '';

        const select = document.createElement('select');
        select.id = 'index-select';
        select.onchange = () => {
            const selectedIndex = select.selectedIndex;
            const selectedOption = select.options[selectedIndex];
            const selectedValue = selectedOption.value;
            showIndexDetails(selectedValue);
        };

        indexList.forEach(index => {
            const option = document.createElement('option');
            option.value = index;
            option.innerText = index;
            select.appendChild(option);
        });

        indexListDiv.appendChild(select);

        // 获取选择的索引名称
        const selectedIndex = document.getElementById('index-select').value;

        // 手动调用 showIndexDetails 函数加载索引详情
        showIndexDetails(selectedIndex);
    }

    // Function to save an index
    async function saveIndex() {
        const indexName = document.getElementById('index-name-display').innerText;

        try {
            const response = await fetch(`${baseURL}/${indexName}/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });

            if (response.ok) {
                console.log('Index saved successfully');
            } else {
                console.log('Failed to save index:', response.status);
            }
        } catch (error) {
            console.log('Error:', error);
        }
    }

    // Function to create an index
    async function createIndex() {
        const indexName = document.getElementById('index-name').value;
        const params = new URLSearchParams();
        params.append('index_name', indexName);

        const response = await fetch(`${baseURL}/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params
        });

        const data = await response.json();
        const createStatus = document.getElementById('create-status');
        createStatus.innerText = data.status;

        if (data.status === 'success') {
            displayIndexList();
        }
    }

    // Function to show index details
    async function showIndexDetails(indexName) {
        const indexNameDisplay = document.getElementById('index-name-display');
        indexNameDisplay.innerText = indexName;

        loadSummary(indexName);

        const response = await fetch(`${baseURL}/${indexName}/info`);
        const data = await response.json();
        const nodeList = data.docs;

        const nodeListDiv = document.getElementById('node-list');
        nodeListDiv.innerHTML = '';

        const rowDiv = document.createElement('div');
        rowDiv.className = 'node-row';
        nodeListDiv.appendChild(rowDiv);

        nodeList.forEach((node, index) => {
            if (index % 3 === 0 && index !== 0) {
                const newRowDiv = document.createElement('div');
                newRowDiv.className = 'node-row';
                nodeListDiv.appendChild(newRowDiv);
            }

            const nodeItem = document.createElement('div');
            nodeItem.className = 'node-item';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'node-info';

            const docIdSpan = document.createElement('span');
            docIdSpan.innerText = `doc_id: ${node.doc_id}`;
            infoDiv.appendChild(docIdSpan);

            infoDiv.appendChild(document.createElement('br'));

            const nodeIdSpan = document.createElement('span');
            nodeIdSpan.innerText = `node_id: ${node.node_id}`;
            infoDiv.appendChild(nodeIdSpan);

            nodeItem.appendChild(infoDiv);

            const textDiv = document.createElement('div');
            textDiv.className = 'node-text';

            const textTextarea = document.createElement('textarea');
            textTextarea.value = node.text;
            textTextarea.oninput = () => updateNode(indexName, node.node_id, textTextarea.value);

            textTextarea.style.width = 'calc(33.33% - 10px)'; // Adjust the width as needed, subtracting any desired margin or padding

            textDiv.appendChild(textTextarea);

            nodeItem.appendChild(textDiv);

            const deleteButton = document.createElement('button');
            deleteButton.innerText = 'Delete';
            deleteButton.onclick = () => deleteNode(indexName, node.node_id);
            nodeItem.appendChild(deleteButton);

            const currentRowDiv = nodeListDiv.lastElementChild;
            currentRowDiv.appendChild(nodeItem);
        });

    }

    // Function to delete an index
    async function deleteIndex() {
        const indexName = document.getElementById('index-name-display').innerText;
        const response = await fetch(`${baseURL}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `index_name=${indexName}`
        });
        const data = await response.json();
        if (data.status === 'deleted') {
            document.getElementById('index-details').innerHTML = '';
            displayIndexList();
        }
    }

    // 在全局范围内声明一个变量用于存储定时器 ID
    let updateTimer;

    // Function to update a node
    async function updateNode(indexName, nodeId, text) {
        // 清除之前的定时器
        clearTimeout(updateTimer);

        // 设置一个新的定时器，在用户停止输入500毫秒后执行更新操作
        updateTimer = setTimeout(async () => {
            const response = await fetch(`${baseURL}/${indexName}/update?nodeId=${nodeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `text=${encodeURIComponent(text)}`
            });

            const data = await response.json();
            if (data.status === 'updated') {
                console.log('Node updated');
            }
        }, 500);
    }

    // Function to delete a node
    async function deleteNode(indexName, nodeId) {
        const response = await fetch(`${baseURL}/${indexName}/deleteNode?node_id=${nodeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        });
        const data = await response.json();
        if (data.status === 'deleted') {
            showIndexDetails(indexName);
        }
    }

    // Function to create a node
    async function createNode() {
        const indexName = document.getElementById('index-name-display').innerText;
        const nodeText = document.getElementById('node-text').value;
        const docId = document.getElementById('doc-id').value;

        const requestBody = new URLSearchParams();
        requestBody.append('text', nodeText);
        requestBody.append('doc_id', docId);

        try {
            const response = await fetch(`${baseURL}/${indexName}/insertdoc`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: requestBody.toString()
            });

            if (response.ok) {
                const data = await response.json();
                console.log('Node created successfully:', data);
                document.getElementById('node-text').value = '';
                document.getElementById('doc-id').value = '';
                showIndexDetails(indexName);
            } else {
                console.log('Failed to create node:', response.status);
            }
        } catch (error) {
            console.log('Error:', error);
        }
    }

    // Function to load and display summary
    async function loadSummary(indexName) {
        const summaryDiv = document.getElementById('summary');

        const response = await fetch(`${baseURL}/${indexName}/get_summary`);
        const data = await response.json();
        const summaryText = document.createElement('p');
        summaryText.innerText = data.summary;
        summaryDiv.innerHTML = '';
        summaryDiv.appendChild(summaryText);
    }

    // Function to edit summary
    async function editSummary() {
        const indexName = document.getElementById('index-name-display').innerText;
        const summaryDiv = document.getElementById('summary');
        const summaryText = summaryDiv.innerText;

        const newSummary = prompt('Enter new summary:', summaryText);
        if (newSummary !== null) {
            const bodyParams = new URLSearchParams();
            bodyParams.append('summary', newSummary);

            const response = await fetch(`${baseURL}/${indexName}/set_summary`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: bodyParams.toString() // 将 URLSearchParams 对象转换为字符串
            });

            const data = await response.json();
            if (data.status === 'ok') {
                summaryDiv.innerHTML = `<p>${data.summary}</p>`;
            }
        }
    }

    // Initial setup
    displayIndexList();

</script>
</body>
</html>